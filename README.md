## 腾讯菁英班 - mini监控系统v2.0.0

### 系统简介

![image-20220222000127120](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222000127120.png)

采用微服务架构理念对系统模块进行拆分重构，增强系统高可用性

###mysql用户密码

用户:密码

monitor:123

root:root 
### mysql数据库 

golang

端口为3307

### 端口定义

在单体上部署整套服务时，可能会遇到端口冲突。

| 端口号 | 备注                   |
| ------ | ---------------------- |
| :8086  | InfluxDB的默认后台端口 |
| :9092  | Kafka默认端口          |
| :2181  | zookeeper默认端口      |
| :8000  | 上报模块1的gRPC端口     |
| :8001  | 上报模块2的gRPC端口     |
| :8002  | 上报模块3的gRPC端口     |
| :8010  | 数据分析模块的gRPC端口 |
| :8020  | 数据分析模块的HTTP端口 |
| :8030  | 告警配置模块的gRPC端口 |
| :8040  | 告警配置模块的HTTP端口 |

### docker ip 映射表

| 模块 | ip地址                   |
| ------ | ---------------------- |
| etcd模块  | 172.19.0.20 |
| agent01 | 172.19.0.2          |
| agent02  | 172.19.0.3      |
| mysql  | 172.19.0.4     |
| data_analyze_service  | 172.19.0.5     |
| report_service01  | 172.19.0.6     |
| report_service02  | 172.19.0.7 |
| report_service03  | 172.19.0.8 |
| persistent_service  | 172.19.0.9 |
| warning_service  | 172.19.0.10 |
| manage_service  | 172.19.0.11 |
| zoo1  | 172.19.0.12 |
| zoo2  | 172.19.0.13 |
| zoo3  | 172.19.0.14 |
| kafka1  | 172.19.0.15 |
| kafka2  | 172.19.0.16 |
| kafka3  | 172.19.0.17 |
| influxdb  | 172.19.0.18 |
| nginx  | 172.19.0.19 |

docker网络组如下：

name: monitor 

subnet: 172.19.0.0/24 #子网

gateway: 172.19.0.1

driver: bridge #网桥模式

### 部署流程

#### Step 1：工具组件的部署

工具组件的部署包括：Kafka，InfluxDB，MySQL等组件的部署。在开启监控系统之前要提前打开这些组件，并把相应一些配置修改添加到相应的模块，如：MySQL的账号、密码、Table等参数；InfluxDB的Organization，Token，Bucket等等。

我的部署方式为：Kafka & InfluxDB 通过Docker启动，MySQL则本地启动。

![image-20220222001131665](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222001131665.png)

![image-20220222001229981](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222001229981.png)



#### Step 2：启动上报模块

上报模块对应于reportService，启动上报模块后，上报模块暴露出:8000端口用于监听来自agent的gRPC请求。

![image-20220222002624400](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222002624400.png)

这个玩意别关。



#### Step 3：启动Agent

Agent模块的功能为将寄宿主机的指标数据以60s的周期向监控系统上报，对应于agentService。

![image-20220222003836620](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222003836620.png)

![image-20220222003848725](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222003848725.png)

开启agent后，agent会将寄宿主机的cpuRate和memRate上报到上报系统。



#### Step 4：启动持久化模块

持久化模块的作用为将Kafka对应Topic的数据进行消费，并持久化到InfluxDB中，持久化模块对应于persistentService。

![image-20220222004124220](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222004124220.png)

启动persistentService后，该模块会将Kafka中对应的数据从头开始消费到尾（这样子其实不好，应该由消费者来管理offset，从上次未读处开始读），数据写进InfluxDB后，浏览器地址栏输入localhost:8086应该可以看到InfluxDB官方提供的数据展示页面。

在该页面输入对应的账号密码后，选择数据的目的地即可查看存储的时序数据。

![image-20220222004230709](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222004230709.png)



#### Step 5：启动数据分析模块

数据分析模块的功能为：向外暴露:8010端口和:8020端口分别提供gRPC服务和HTTP服务

![image-20220222090156819](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222090156819.png)

至此，数据分析模块部署完成，监控系统具备了向外提供数据分析的功能。

=======
#### Step 6：启动告警配置模块

![image-20220222195016261](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222195016261.png)



#### Step 7：启动告警通知模块

![image-20220222195042639](http://feifan0820.oss-cn-shenzhen.aliyuncs.com/img/image-20220222195042639.png)





### 接口示例

#### 数据分析模块

###### FindRecordsByLocation

通过机房的维度查询监控指标

```json
[
    {
        "host_id": "Kevin-D20",
        "metrics_type": "CPU_Rate",
        "metrics_value": [
            7.884615421295166,
            12.109375,
            14.453125,
            9.1796875,
            11.923076629638672,
            8.7890625,
            10.3515625,
            4.038461685180664,
            30.46875,
            9.1796875,
            5.2734375,
            13.461538314819336,
            12.5,
            9.9609375,
            7.6171875,
            9.765625,
            2.127659559249878,
            7.6171875,
            17.884614944458008,
            9.375,
            13.671875,
            18.75,
            15.769230842590332,
            28.90625,
            14.807692527770996,
            6.92307710647583,
            23.4375,
            7.8125,
            3.515625,
            13.671875,
            38.671875,
            15.0390625,
            22.69230842590332,
            8.461538314819336,
            16.6015625,
            15.961538314819336,
            22.4609375,
            19.615385055541992,
            22.115385055541992,
            7.5,
            7.5,
            15.384614944458008,
            14.423076629638672,
            23.269229888916016,
            15.192307472229004,
            12.890625,
            16.40625,
            8.076923370361328,
            10.9375,
            15,
            13.269230842590332,
            16.2109375,
            10.9375,
            16.923076629638672,
            18.653846740722656,
            33.7890625,
            15.8203125,
            19.230770111083984
        ],
        "time_stamp": [
            1645607160,
            1645607220,
            1645607280,
            1645607340,
            1645607400,
            1645607460,
            1645607520,
            1645607580,
            1645607640,
            1645607700,
            1645607760,
            1645607820,
            1645607880,
            1645607940,
            1645608000,
            1645608060,
            1645608120,
            1645608180,
            1645608240,
            1645608300,
            1645608360,
            1645608420,
            1645608480,
            1645608540,
            1645608600,
            1645608660,
            1645608720,
            1645608780,
            1645608840,
            1645608900,
            1645608960,
            1645609080,
            1645609140,
            1645609200,
            1645609260,
            1645609320,
            1645609380,
            1645609440,
            1645609500,
            1645609560,
            1645609620,
            1645609680,
            1645609740,
            1645609800,
            1645609860,
            1645609920,
            1645609980,
            1645610040,
            1645610100,
            1645610160,
            1645610220,
            1645610280,
            1645610340,
            1645610400,
            1645610460,
            1645610520,
            1645610580,
            1645610640
        ]
    },
    {
        "host_id": "Kevin-D30",
        "metrics_type": "CPU_Rate",
        "metrics_value": [
            3.6994218826293945,
            1.384615421295166,
            10.3125,
            5.769230842590332,
            14.53125,
            2.538461446762085,
            4.846153736114502,
            5.307692527770996,
            5.15625,
            2.769230842590332,
            21.328125,
            24.140625,
            15.230769157409668,
            7.846153736114502,
            17.578125,
            19.615385055541992,
            15.230769157409668,
            6.09375,
            21.230770111083984,
            7.734375,
            18.69230842590332,
            18.28125,
            15.923076629638672,
            49.921875,
            12.692307472229004,
            20.30769157409668,
            15.46875,
            8.203125,
            8.076923370361328,
            10.78125,
            31.40625,
            21.923076629638672,
            18.28125,
            31.590909957885742,
            20.30769157409668,
            7.615384578704834,
            5.07692289352417,
            23.538461685180664,
            9.461538314819336,
            18.69230842590332,
            10.3125,
            7.96875,
            22.846153259277344,
            10.21276569366455,
            9.609375,
            9,
            32.769229888916016,
            12.890625,
            24.461538314819336,
            19.846153259277344,
            28.359375,
            8.769230842590332,
            10.84615421295166,
            22.265625,
            11.538461685180664,
            70.6692123413086,
            12.461538314819336,
            21.5625,
            35.390625
        ],
        "time_stamp": [
            1645607100,
            1645607160,
            1645607280,
            1645607340,
            1645607400,
            1645607460,
            1645607520,
            1645607580,
            1645607640,
            1645607700,
            1645607760,
            1645607820,
            1645607880,
            1645607940,
            1645608000,
            1645608060,
            1645608120,
            1645608180,
            1645608240,
            1645608300,
            1645608360,
            1645608420,
            1645608480,
            1645608540,
            1645608600,
            1645608660,
            1645608720,
            1645608780,
            1645608840,
            1645608900,
            1645608960,
            1645609020,
            1645609080,
            1645609140,
            1645609200,
            1645609320,
            1645609380,
            1645609440,
            1645609500,
            1645609560,
            1645609620,
            1645609680,
            1645609740,
            1645609800,
            1645609860,
            1645609920,
            1645609980,
            1645610040,
            1645610100,
            1645610160,
            1645610220,
            1645610280,
            1645610340,
            1645610400,
            1645610460,
            1645610520,
            1645610580,
            1645610640,
            1645610688
        ]
    }
]
```





#### 系统配置模块

##### InsertAHost

````json
{
    "CODE": 200,
    "MSG": "Insert success!",
    "DATA": {
        "num": 1
    }
}
````



##### FindAllHost

```json
{
    "CODE": 200,
    "MSG": "Find success!",
    "DATA": [
        {
            "ID": 5,
            "CreatedAt": "2022-02-23T13:44:04.949+08:00",
            "UpdatedAt": "2022-02-23T13:44:04.949+08:00",
            "DeletedAt": null,
            "HostID": "Kevin-D40",
            "Location": "725"
        },
        {
            "ID": 6,
            "CreatedAt": "2022-02-23T13:51:55.599+08:00",
            "UpdatedAt": "2022-02-23T13:51:55.599+08:00",
            "DeletedAt": null,
            "HostID": "Kevin-D20",
            "Location": "726"
        }
    ]
}
```



##### UpdateHostMsg

```json
{
    "code": 200,
    "data": "ok",
    "msg": "更新成功"
}
```



##### FindNotManagedHosts

设 hostFromInfluxDB = {hostA, hostB, hostC}，而hostFromMySQL = {hostA}，那么该接口返回 {hostB, hostC}，即系统还未配置hostB和hostC的Location信息

```json
{
    "CODE": 200,
    "MSG": "Find success!",
    "DATA": [
        "Kevin-D20"
    ]
}
```

若全部成功上报数据的主机都已完成Location字段的配置，那么该接口返回

```json
{
    "CODE": 200,
    "MSG": "Find success!",
    "DATA": []
}
```
